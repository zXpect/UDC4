{% extends 'base.html' %}

{% block title %}{{ title }} - NetSchool UDC{% endblock %}

{% block extra_css %}
<style>
    .public-files-page {
        /* Add top padding to prevent overlap with a fixed navbar */
        /* The existing my-5 class adds 3rem margin, this padding is additional */
        padding-top: 2.5rem; /* Adjust this value based on your navbar's actual height */
    }

    .public-files-page .page-header {
        padding: 2rem 0;
        margin-bottom: 3rem; /* Increased margin */
        text-align: center;
        border-bottom: 1px solid var(--border-subtle, var(--border));
        border-radius: 0;
    }
    .public-files-page .page-header h1 {
        font-weight: 600;
        color: var(--text-primary);
        font-size: clamp(1.8rem, 5vw, 2.5rem);
    }
    .public-files-page .page-header p {
        font-size: clamp(0.9rem, 2.5vw, 1.1rem);
        color: var(--text-secondary);
        max-width: 700px;
        margin: 0.75rem auto 0; /* Increased top margin */
    }

    .public-files-page .search-bar-container {
        margin-bottom: 3rem; /* Increased margin */
        position: relative;
    }
    .public-files-page .search-bar-container .form-control {
        padding: 0.85rem 1.75rem 0.85rem 3.25rem;
        border-radius: var(--radius-full);
        border: 1px solid var(--border);
        box-shadow: var(--shadow-sm);
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }
    .public-files-page .search-bar-container .form-control:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.2), var(--shadow-md);
    }
    .public-files-page .search-bar-container .search-icon {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        color: var(--text-muted);
        font-size: 1rem;
    }

    .public-files-page .file-card {
        background-color: var(--surface);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
        transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%;
        overflow: hidden;
    }
    .public-files-page .file-card:hover {
        transform: translateY(-6px);
        box-shadow: var(--shadow-lg);
        border-color: var(--primary);
    }

    .public-files-page .file-card-icon-top {
        padding: 1.5rem;
        text-align: center;
        font-size: 3rem;
        color: var(--primary);
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .public-files-page .file-card-icon-top i {
        opacity: 0.8;
    }

    .public-files-page .file-card-body {
        padding: 1.25rem 1.5rem 1.5rem; /* Adjusted padding */
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }
    .public-files-page .file-card-title {
        font-weight: 600;
        color: var(--text-primary);
        font-size: var(--text-lg);
        margin-bottom: 0.75rem; /* Increased margin */
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.4;
        min-height: calc(1.4em * 2);
    }
    .public-files-page .file-card-description {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin-bottom: 1.25rem; /* Increased margin */
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        flex-grow: 1;
        line-height: 1.5;
        min-height: calc(1.5em * 3);
    }
    .public-files-page .file-card-meta {
        font-size: var(--text-xs);
        color: var(--text-muted);
        margin-bottom: 1.25rem; /* Increased margin */
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.75rem; /* Increased gap */
    }
    .public-files-page .file-card-meta .badge {
        font-weight: 500;
        padding: 0.3em 0.6em;
    }
    .public-files-page .file-card-actions {
        margin-top: auto;
        border-top: 1px solid var(--border);
        padding-top: 1rem;
        display: flex;
        justify-content: space-between;
        gap: 0.75rem; /* Increased gap */
    }
    .public-files-page .file-card-actions .btn {
        flex-grow: 1;
    }
    .public-files-page .file-card-actions .btn + .btn {
        margin-top: 0;
    }
     @media (min-width: 576px) {
        .public-files-page .file-card-actions .btn {
            width: auto;
            flex-grow: 0;
        }
        .public-files-page .file-card-actions .btn + .btn {
        }
        .public-files-page .file-card-actions {
             justify-content: flex-end;
        }
    }
    @media (max-width: 380px) {
        .public-files-page .file-card-actions {
            flex-direction: column;
        }
        .public-files-page .file-card-actions .btn {
            width: 100%;
        }
        .public-files-page .file-card-actions .btn + .btn {
            margin-left: 0;
            margin-top: 0.5rem;
        }
    }


    .public-files-page .empty-state-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px;
        width: 100%;
    }
    .public-files-page .empty-state {
        text-align: center;
        padding: 2rem;
        background-color: var(--surface);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
        max-width: 500px;
    }
    .public-files-page .empty-state i {
        font-size: 3.5rem;
        margin-bottom: 1.5rem;
        color: var(--text-muted);
        opacity: 0.7;
    }
    .public-files-page .empty-state h5 {
        font-weight: 600;
        color: var(--text-secondary);
        margin-bottom: 0.5rem;
        font-size: 1.1rem;
    }
    .public-files-page .empty-state p {
        color: var(--text-muted);
        font-size: var(--text-sm);
    }

    .public-files-page .modal-content {
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-xl);
    }
    .public-files-page .modal-header {
        border-bottom-color: var(--border);
        padding: 1rem 1.5rem;
    }
    .public-files-page .modal-footer {
        border-top-color: var(--border);
        padding: 1rem 1.5rem;
    }
    .public-files-page .modal-body dt {
        font-weight: 500;
        color: var(--text-secondary);
    }
    .public-files-page .modal-body dd {
        color: var(--text-primary);
    }

    /* Dark theme adaptations */
    [data-bs-theme="dark"] .public-files-page .page-header {
        border-bottom-color: var(--bs-gray-700);
    }
    [data-bs-theme="dark"] .public-files-page .search-bar-container .form-control {
        background-color: var(--bs-gray-700);
        border-color: var(--bs-gray-600);
        color: var(--bs-light);
    }
    [data-bs-theme="dark"] .public-files-page .search-bar-container .form-control::placeholder {
        color: var(--bs-gray-500);
    }
    [data-bs-theme="dark"] .public-files-page .search-bar-container .form-control:focus {
        background-color: var(--bs-gray-700);
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(var(--primary-rgb), 0.25);
    }
    [data-bs-theme="dark"] .public-files-page .file-card {
        background-color: var(--bs-gray-800);
        border-color: var(--bs-gray-700);
    }
    [data-bs-theme="dark"] .public-files-page .file-card:hover {
        border-color: var(--primary);
        background-color: var(--bs-gray-750);
    }
    [data-bs-theme="dark"] .public-files-page .file-card-title {
        color: var(--bs-light);
    }
    [data-bs-theme="dark"] .public-files-page .file-card-description {
        color: var(--bs-gray-400);
    }
    [data-bs-theme="dark"] .public-files-page .file-card-meta {
        color: var(--bs-gray-500);
    }
    [data-bs-theme="dark"] .public-files-page .file-card-meta .badge {
        background-color: var(--bs-gray-600) !important;
        color: var(--bs-light) !important;
        border-color: var(--bs-gray-500) !important;
    }
    [data-bs-theme="dark"] .public-files-page .file-card-actions {
        border-top-color: var(--bs-gray-700);
    }
    [data-bs-theme="dark"] .public-files-page .empty-state {
        background-color: var(--bs-gray-800);
        box-shadow: var(--shadow-md-dark);
    }
    [data-bs-theme="dark"] .public-files-page .empty-state i {
        color: var(--bs-gray-500);
    }
    [data-bs-theme="dark"] .public-files-page .empty-state h5 {
        color: var(--bs-gray-300);
    }
    [data-bs-theme="dark"] .public-files-page .empty-state p {
        color: var(--bs-gray-500);
    }
    [data-bs-theme="dark"] .public-files-page .modal-content {
        background-color: var(--bs-gray-800);
        border-color: var(--bs-gray-700);
    }
    [data-bs-theme="dark"] .public-files-page .modal-header {
        border-bottom-color: var(--bs-gray-700);
    }
    [data-bs-theme="dark"] .public-files-page .modal-header .modal-title {
        color: var(--bs-light);
    }
    [data-bs-theme="dark"] .public-files-page .modal-header .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%);
    }
    [data-bs-theme="dark"] .public-files-page .modal-body {
        color: var(--bs-gray-300);
    }
    [data-bs-theme="dark"] .public-files-page .modal-body dt {
        color: var(--bs-gray-400);
    }
    [data-bs-theme="dark"] .public-files-page .modal-body dd {
        color: var(--bs-light);
    }
    [data-bs-theme="dark"] .public-files-page .modal-footer {
        border-top-color: var(--bs-gray-700);
    }
    [data-bs-theme="dark"] #publicFileCountFooterContainer small {
        color: var(--bs-gray-500) !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="container my-5 public-files-page">
    <div class="page-header">
        <h1 class="display-5">{{ title }}</h1>
        <p class="lead">Documentos e información de interés general para toda la comunidad.</p>
    </div>

    <div class="search-bar-container">
        <i class="fas fa-search search-icon"></i>
        <input type="text" id="publicFileSearchInput" class="form-control" placeholder="Buscar por título o descripción...">
    </div>

    <div class="row gy-5" id="publicFilesContainer">
        {% if files %}
            {% for file in files %}
            <div class="col-md-6 col-lg-4 file-item d-flex">
                <div class="card file-card w-100">
                    <div class="file-card-icon-top">
                        {% set icon_class = 'fas fa-file-alt text-secondary' %}
                        {% if file.file_type and ('pdf' in file.file_type or file.file_type == 'application/pdf') %} {% set icon_class = 'fas fa-file-pdf text-danger' %}
                        {% elif file.file_type and ('word' in file.file_type or 'officedocument.wordprocessingml' in file.file_type) %} {% set icon_class = 'fas fa-file-word text-primary' %}
                        {% elif file.file_type and ('excel' in file.file_type or 'officedocument.spreadsheetml' in file.file_type) %} {% set icon_class = 'fas fa-file-excel text-success' %}
                        {% elif file.file_type and ('powerpoint' in file.file_type or 'officedocument.presentationml' in file.file_type) %} {% set icon_class = 'fas fa-file-powerpoint text-warning' %}
                        {% elif file.file_type and ('image' in file.file_type) %} {% set icon_class = 'fas fa-file-image text-info' %}
                        {% elif file.file_type and ('zip' in file.file_type or 'archive' in file.file_type) %} {% set icon_class = 'fas fa-file-archive text-dark' %}
                        {% endif %}
                        <i class="{{ icon_class }}"></i>
                    </div>
                    <div class="file-card-body">
                        <h5 class="file-card-title card-title" data-search-title>{{ file.title }}</h5>
                        <p class="file-card-description card-text" data-search-description>
                            {{ file.description if file.description else 'Sin descripción disponible.' }}
                        </p>
                        <div class="file-card-meta">
                            <span class="badge bg-light text-dark border text-uppercase">{{ file.file_type.split('/')[-1] if '/' in file.file_type else file.file_type if file.file_type else 'N/A' }}</span>
                            <span><i class="far fa-calendar-alt me-1"></i> {{ file.created_at.strftime('%d/%m/%Y') if file.created_at else 'N/A' }}</span>
                        </div>
                        <div class="file-card-actions">
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="Ver detalles" data-bs-toggle="tooltip"
                                    onclick='viewFileDetailsPublic("{{ file._id|string }}")'>
                                <i class="fas fa-eye"></i><span class="ms-1 d-none d-md-inline">Detalles</span>
                            </button>
                            <a href="{{ url_for('public.download_general_file', file_id_str=file._id) }}" class="btn btn-sm btn-primary" title="Descargar" data-bs-toggle="tooltip">
                                <i class="fas fa-download"></i><span class="ms-1 d-none d-md-inline">Descargar</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <div id="noPublicFilesMessageContainer" class="mt-4" style="display: none;">
         <div class="empty-state-container">
            <div class="empty-state">
                <i class="fas fa-folder-open" id="emptyStateIcon"></i>
                <h5 id="emptyStateTitle">No hay documentos generales disponibles.</h5>
                <p id="emptyStateText" class="text-muted small">Cuando se publiquen archivos de interés general, aparecerán aquí.</p>
            </div>
        </div>
    </div>
     <div id="publicFileCountFooterContainer" class="mt-3 text-center" {% if not files %}style="display:none;"{% endif %}>
        <small class="text-muted" id="publicFileCountFooter">
            {% if files %}Mostrando {{ files|length }} documento{{ 's' if files|length != 1 else '' }} público{{ 's' if files|length != 1 else '' }}.{% endif %}
        </small>
    </div>


</div>

<div class="modal fade" id="fileDetailsModalPublic" tabindex="-1" aria-labelledby="fileDetailsModalPublicLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fileDetailsModalPublicLabel"><i class="fas fa-info-circle me-2"></i>Detalles del Documento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="fileDetailsContentPublic" style="min-height: 150px;">
                <div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><p class="mt-2 mb-0">Cargando detalles...</p></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"><i class="fas fa-times me-1"></i>Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function viewFileDetailsPublic(fileId) {
    const modal = new bootstrap.Modal(document.getElementById('fileDetailsModalPublic'));
    const content = document.getElementById('fileDetailsContentPublic');
    content.innerHTML = '<div class="text-center p-4"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div><p class="mt-2 mb-0">Cargando detalles...</p></div>';
    modal.show();

    fetch(`{{ url_for('public.get_public_file_details_json', file_id_str='FILE_ID_PLACEHOLDER') }}`.replace('FILE_ID_PLACEHOLDER', fileId))
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                const file = data.file;
                let htmlContent = '<dl class="row gy-3">';
                htmlContent += '<dt class="col-sm-4 text-muted">Título:</dt>';
                htmlContent += '<dd class="col-sm-8">' + (file.title || 'N/A') + '</dd>';

                htmlContent += '<dt class="col-sm-4 text-muted">Descripción:</dt>';
                htmlContent += '<dd class="col-sm-8" style="white-space: pre-line; word-wrap: break-word;">' + (file.description || 'Sin descripción.') + '</dd>';

                htmlContent += '<dt class="col-sm-4 text-muted">Tipo de Archivo:</dt>';
                let fileTypeDisplay = 'N/A';
                if (file.file_type) {
                    fileTypeDisplay = file.file_type.includes('/') ? file.file_type.split('/')[1] : file.file_type;
                }
                htmlContent += '<dd class="col-sm-8 text-uppercase">' + fileTypeDisplay + '</dd>';

                htmlContent += '<dt class="col-sm-4 text-muted">Fecha de Publicación:</dt>';
                let createdAtDisplay = 'N/A';
                if (file.created_at) {
                    try {
                        const date = new Date(file.created_at);
                        createdAtDisplay = date.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    } catch (e) {
                        createdAtDisplay = file.created_at.split(' ')[0] || 'N/A';
                    }
                }
                htmlContent += '<dd class="col-sm-8">' + createdAtDisplay + '</dd>';

                htmlContent += '<dt class="col-sm-4 text-muted">ID Documento:</dt>';
                htmlContent += '<dd class="col-sm-8"><small class="text-body-secondary">' + (file.id) + '</small></dd>';
                htmlContent += '</dl>';
                content.innerHTML = htmlContent;
            } else {
                content.innerHTML = '<div class="alert alert-danger mb-0">Error: ' + (data.error || 'No se pudieron cargar los detalles.') + '</div>';
            }
        })
        .catch(error => {
            console.error('Error fetching file details:', error);
            content.innerHTML = '<div class="alert alert-danger mb-0">Error de conexión al cargar detalles. Por favor, intente más tarde.</div>';
        });
}

document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('publicFileSearchInput');
    const filesContainer = document.getElementById('publicFilesContainer');
    const noFilesMessageContainer = document.getElementById('noPublicFilesMessageContainer');
    const emptyStateIcon = document.getElementById('emptyStateIcon');
    const emptyStateTitle = document.getElementById('emptyStateTitle');
    const emptyStateText = document.getElementById('emptyStateText');
    const fileCountFooterContainer = document.getElementById('publicFileCountFooterContainer');
    const fileCountFooterText = document.getElementById('publicFileCountFooter');
    const initialPageLoad = true;

    const allFileItems = Array.from(filesContainer.querySelectorAll('.file-item'));
    const initialFileCount = allFileItems.length;

    function updateFileDisplay(searchTerm = '') {
        let visibleCount = 0;
        searchTerm = searchTerm.toLowerCase().trim();

        allFileItems.forEach(item => {
            const titleElement = item.querySelector('[data-search-title]');
            const descriptionElement = item.querySelector('[data-search-description]');
            const title = (titleElement ? titleElement.textContent : '').toLowerCase();
            const description = (descriptionElement ? descriptionElement.textContent : '').toLowerCase();

            if (title.includes(searchTerm) || description.includes(searchTerm)) {
                item.style.display = '';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });

        if (visibleCount === 0) {
            noFilesMessageContainer.style.display = '';
            filesContainer.style.display = 'none';
             if (searchTerm) {
                emptyStateIcon.className = 'fas fa-search fa-2x';
                emptyStateTitle.textContent = 'No se encontraron documentos.';
                emptyStateText.textContent = 'Intenta con diferentes palabras clave o revisa la ortografía.';
            } else {
                emptyStateIcon.className = 'fas fa-folder-open fa-2x';
                emptyStateTitle.textContent = 'No hay documentos generales disponibles.';
                emptyStateText.textContent = 'Cuando se publiquen archivos de interés general, aparecerán aquí.';
            }
        } else {
            noFilesMessageContainer.style.display = 'none';
            filesContainer.style.display = '';
        }
        
        if (fileCountFooterContainer && fileCountFooterText) {
            if (visibleCount > 0) {
                let footerMsg = 'Mostrando ' + visibleCount + ' documento' + (visibleCount !== 1 ? 's' : '') + ' público' + (visibleCount !== 1 ? 's' : '');
                if (searchTerm) {
                    footerMsg += ' (filtrado)';
                }
                footerMsg += '.';
                fileCountFooterText.textContent = footerMsg;
                fileCountFooterContainer.style.display = '';
            } else if (initialFileCount > 0 && searchTerm) {
                fileCountFooterText.textContent = 'No se encontraron coincidencias.';
                fileCountFooterContainer.style.display = '';
            } else if (initialFileCount === 0 && !searchTerm) {
                 fileCountFooterContainer.style.display = 'none';
                 noFilesMessageContainer.style.display = '';
                 filesContainer.style.display = 'none';
                 emptyStateIcon.className = 'fas fa-folder-open fa-2x';
                 emptyStateTitle.textContent = 'No hay documentos generales disponibles.';
                 emptyStateText.textContent = 'Cuando se publiquen archivos de interés general, aparecerán aquí.';
            } else {
                 fileCountFooterContainer.style.display = 'none';
            }
        }
    }

    if (searchInput) {
        searchInput.addEventListener('input', function() {
            updateFileDisplay(this.value);
        });
    }

    if (initialPageLoad) {
        if (initialFileCount === 0) {
            noFilesMessageContainer.style.display = '';
            filesContainer.style.display = 'none';
            if (fileCountFooterContainer) fileCountFooterContainer.style.display = 'none';
            emptyStateIcon.className = 'fas fa-folder-open fa-2x';
            emptyStateTitle.textContent = 'No hay documentos generales disponibles.';
            emptyStateText.textContent = 'Cuando se publiquen archivos de interés general, aparecerán aquí.';
        } else {
            updateFileDisplay();
        }
    }

    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});
</script>
{% endblock %} 