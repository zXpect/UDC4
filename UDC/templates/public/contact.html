{% extends 'base.html' %}

{% block title %}Contacto - NetSchool UDC{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Header de página -->
    <div class="section-header fade-in-up">
        <h1 class="section-title">Contacto</h1>
        <p class="section-subtitle">Estamos aquí para ayudarte. Contáctanos para cualquier consulta o información que necesites.</p>
    </div>

    <div class="row g-4">
        <!-- Información de contacto -->
        <div class="col-lg-4">
            <div class="modern-card h-100 fade-in-up delay-100">
                <div class="modern-card-header">
                    <div class="icon-container">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <h3 class="h4 mb-0">Información de Contacto</h3>
                </div>
                <div class="modern-card-body">
                    <div class="contact-info">
                        <div class="d-flex align-items-center mb-4 hover-translate">
                            <div class="icon-container me-3">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div>
                                <h5 class="h6 mb-1">Dirección</h5>
                                <p class="mb-0">Calle 8 Centro, Ubaté, Cundinamarca</p>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center mb-4 hover-translate">
                            <div class="icon-container me-3">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div>
                                <h5 class="h6 mb-1">Teléfono</h5>
                                <p class="mb-0">+57 (1) 825 4400</p>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center mb-4 hover-translate">
                            <div class="icon-container me-3">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div>
                                <h5 class="h6 mb-1">Email</h5>
                                <p class="mb-0">info@netschool.ucundinamarca.edu.co</p>
                            </div>
                        </div>
                        
                        <div class="d-flex align-items-center hover-translate">
                            <div class="icon-container me-3">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div>
                                <h5 class="h6 mb-1">Horario de Atención</h5>
                                <p class="mb-0">Lunes a Viernes: 8:00 AM - 4:00 PM</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Formulario de contacto -->
        <div class="col-lg-8">
            <div class="modern-card h-100 fade-in-up delay-200">
                <div class="modern-card-header">
                    <div class="icon-container">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <h3 class="h4 mb-0">Envíanos un Mensaje</h3>
                </div>
                <div class="modern-card-body">
                    <form id="contactForm" class="needs-validation" novalidate>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="name" placeholder="Nombre" required>
                                    <label for="name">Nombre</label>
                                    <div class="invalid-feedback">
                                        Por favor ingresa tu nombre
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input type="email" class="form-control" id="email" placeholder="Email" required>
                                    <label for="email">Email</label>
                                    <div class="invalid-feedback">
                                        Por favor ingresa un email válido
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="text" class="form-control" id="subject" placeholder="Asunto" required>
                                    <label for="subject">Asunto</label>
                                    <div class="invalid-feedback">
                                        Por favor ingresa un asunto
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="message" placeholder="Mensaje" style="height: 150px" required></textarea>
                                    <label for="message">Mensaje</label>
                                    <div class="invalid-feedback">
                                        Por favor ingresa tu mensaje
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Enviar Mensaje
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Mapa Section - Con más separación -->
    <div class="row" style="margin-top: 5rem;">
        <div class="col-12">
            <div class="modern-card fade-in-up delay-300">
                <div class="modern-card-header">
                    <div class="icon-container">
                        <i class="fas fa-map"></i>
                    </div>
                    <h3 class="h4 mb-0">Nuestra Ubicación</h3>
                </div>
                <div class="modern-card-body p-0">
                    <!-- Loading indicator -->
                    <div id="mapLoader" class="map-loader">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Cargando mapa...</span>
                        </div>
                        <p class="mt-2 mb-0">Cargando mapa...</p>
                    </div>
                    
                    <!-- Map container -->
                    <div class="map-container" id="mapContainer" style="display: none;">
                        <div id="map" style="width: 100%; height: 450px;"></div>
                    </div>
                    
                    <!-- Error fallback -->
                    <div id="mapError" class="map-error" style="display: none;">
                        <div class="text-center p-4">
                            <i class="fas fa-exclamation-triangle text-warning mb-3" style="font-size: 2rem;"></i>
                            <h5>Error al cargar el mapa</h5>
                            <p class="text-muted mb-3">No se pudo cargar el mapa de Google Maps.</p>
                            <button class="btn btn-primary" onclick="retryMapLoad()">
                                <i class="fas fa-redo me-2"></i>
                                Intentar de nuevo
                            </button>
                            <div class="mt-3">
                                <a href="https://www.google.com/maps/place/5.30933,-73.81575" 
                                   target="_blank" 
                                   class="btn btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-2"></i>
                                    Ver en Google Maps
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Variables globales para el mapa
let map = null;
let marker = null;
let infoWindow = null;
let mapInitialized = false;
let mapLoadAttempts = 0;
const maxLoadAttempts = 3;

// Configuración del mapa
const mapConfig = {
    location: { lat: 5.30933, lng: -73.81575 },
    zoom: 17,
    mapTypeId: 'roadmap'
};

// Función para mostrar/ocultar elementos del mapa
function toggleMapElements(showLoader = false, showMap = false, showError = false) {
    const loader = document.getElementById('mapLoader');
    const mapContainer = document.getElementById('mapContainer');
    const mapError = document.getElementById('mapError');
    
    if (loader) loader.style.display = showLoader ? 'flex' : 'none';
    if (mapContainer) mapContainer.style.display = showMap ? 'block' : 'none';
    if (mapError) mapError.style.display = showError ? 'block' : 'none';
}

// Función para limpiar el mapa anterior
function cleanupMap() {
    if (marker) {
        marker.setMap(null);
        marker = null;
    }
    if (infoWindow) {
        infoWindow.close();
        infoWindow = null;
    }
    if (map) {
        map = null;
    }
    mapInitialized = false;
}

// Función para crear el contenido de la ventana de información
function createInfoWindowContent() {
    return `
        <div class="info-window-content" style="max-width: 280px; padding: 15px;">
            <div style="display: flex; align-items: center; margin-bottom: 10px;">
                <div style="background: #007bff; color: white; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; margin-right: 12px; font-weight: bold; font-size: 14px;">
                    UDC
                </div>
                <div>
                    <h4 style="margin: 0; color: #007bff; font-size: 16px; font-weight: 600;">NetSchool UDC</h4>
                    <p style="margin: 0; color: #6c757d; font-size: 12px;">Universidad de Cundinamarca</p>
                </div>
            </div>
            
            <div style="border-top: 1px solid #e9ecef; padding-top: 12px;">
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <i class="fas fa-map-marker-alt" style="color: #007bff; width: 16px; margin-right: 8px;"></i>
                    <span style="font-size: 13px; color: #495057;">Calle 8 Centro, Ubaté, Cundinamarca</span>
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <i class="fas fa-phone" style="color: #007bff; width: 16px; margin-right: 8px;"></i>
                    <span style="font-size: 13px; color: #495057;">+57 (1) 825 4400</span>
                </div>
                
                <div style="display: flex; align-items: center; margin-bottom: 8px;">
                    <i class="fas fa-envelope" style="color: #007bff; width: 16px; margin-right: 8px;"></i>
                    <span style="font-size: 13px; color: #495057;">info@netschool.ucundinamarca.edu.co</span>
                </div>
                
                <div style="display: flex; align-items: center;">
                    <i class="fas fa-clock" style="color: #007bff; width: 16px; margin-right: 8px;"></i>
                    <span style="font-size: 13px; color: #495057;">Lunes a Viernes: 8:00 AM - 4:00 PM</span>
                </div>
            </div>
            
            <div style="border-top: 1px solid #e9ecef; padding-top: 12px; margin-top: 12px;">
                <a href="https://www.google.com/maps/dir/?api=1&destination=${mapConfig.location.lat},${mapConfig.location.lng}" 
                   target="_blank" 
                   style="display: inline-flex; align-items: center; background: #007bff; color: white; padding: 8px 12px; border-radius: 6px; text-decoration: none; font-size: 12px; font-weight: 500; transition: background 0.3s ease;"
                   onmouseover="this.style.background='#0056b3'"
                   onmouseout="this.style.background='#007bff'">
                    <i class="fas fa-directions" style="margin-right: 6px;"></i>
                    Cómo llegar
                </a>
            </div>
        </div>
    `;
}

// Función principal para inicializar el mapa
function initMap() {
    try {
        // Limpiar cualquier mapa anterior
        cleanupMap();
        
        // Verificar que Google Maps esté disponible
        if (typeof google === 'undefined' || !google.maps) {
            throw new Error('Google Maps API no está disponible');
        }

        // Crear el mapa
        const mapElement = document.getElementById("map");
        if (!mapElement) {
            throw new Error('Elemento del mapa no encontrado');
        }

        map = new google.maps.Map(mapElement, {
            zoom: mapConfig.zoom,
            center: mapConfig.location,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            gestureHandling: 'cooperative',
            zoomControl: true,
            mapTypeControl: false,
            scaleControl: true,
            streetViewControl: true,
            rotateControl: false,
            fullscreenControl: true,
            styles: [
                {
                    featureType: "poi",
                    elementType: "labels",
                    stylers: [{ visibility: "off" }]
                }
            ]
        });

        // Crear el marcador
        marker = new google.maps.Marker({
            position: mapConfig.location,
            map: map,
            title: "Universidad de Cundinamarca - NetSchool UDC",
            animation: google.maps.Animation.DROP,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                fillColor: '#007bff',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 3,
                scale: 12
            }
        });

        // Crear la ventana de información
        infoWindow = new google.maps.InfoWindow({
            content: createInfoWindowContent(),
            pixelOffset: new google.maps.Size(0, -10)
        });

        // Event listeners
        marker.addListener("click", () => {
            infoWindow.open(map, marker);
        });

        map.addListener("click", () => {
            infoWindow.close();
        });

        // Mostrar el mapa y ocultar el loader
        toggleMapElements(false, true, false);
        
        // Mostrar automáticamente la ventana de información
        setTimeout(() => {
            if (infoWindow && map && marker) {
                infoWindow.open(map, marker);
            }
        }, 1000);

        mapInitialized = true;
        mapLoadAttempts = 0;
        
        console.log('Mapa inicializado exitosamente');

    } catch (error) {
        console.error('Error al inicializar el mapa:', error);
        handleMapError();
    }
}

// Función para manejar errores del mapa
function handleMapError() {
    mapLoadAttempts++;
    
    if (mapLoadAttempts < maxLoadAttempts) {
        console.log(`Reintentando cargar el mapa (intento ${mapLoadAttempts + 1}/${maxLoadAttempts})`);
        setTimeout(() => {
            loadGoogleMaps();
        }, 2000);
    } else {
        console.error('No se pudo cargar el mapa después de varios intentos');
        toggleMapElements(false, false, true);
    }
}

// Función para cargar la API de Google Maps
function loadGoogleMaps() {
    // Verificar si ya está cargada
    if (typeof google !== 'undefined' && google.maps) {
        initMap();
        return;
    }

    // Mostrar loader
    toggleMapElements(true, false, false);

    // Crear script para cargar la API
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyA6j7YaKesOKWEgaGTsNruStFRKH0pxeQY&callback=initMap&libraries=geometry`;
    script.async = true;
    script.defer = true;
    
    script.onerror = function() {
        console.error('Error al cargar el script de Google Maps');
        handleMapError();
    };

    // Remover script anterior si existe
    const existingScript = document.querySelector('script[src*="maps.googleapis.com"]');
    if (existingScript) {
        existingScript.remove();
    }

    document.head.appendChild(script);
}

// Función para reintentar cargar el mapa
function retryMapLoad() {
    mapLoadAttempts = 0;
    cleanupMap();
    loadGoogleMaps();
}

// Función para redimensionar el mapa
function resizeMap() {
    if (map && mapInitialized) {
        google.maps.event.trigger(map, 'resize');
        map.setCenter(mapConfig.location);
    }
}

// Event listeners del documento
document.addEventListener('DOMContentLoaded', function() {
    // Configuración del observador para animaciones
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.animationPlayState = 'running';
            }
        });
    }, observerOptions);

    // Observar elementos con animación fade-in-up
    document.querySelectorAll('.fade-in-up').forEach(el => {
        el.style.animationPlayState = 'paused';
        observer.observe(el);
    });

    // Validación del formulario
    const form = document.getElementById('contactForm');
    if (form) {
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            if (!form.checkValidity()) {
                event.stopPropagation();
            } else {
                // Aquí puedes agregar la lógica para enviar el formulario
                alert('Formulario enviado correctamente (simulado)');
            }
            form.classList.add('was-validated');
        });
    }

    // Cargar el mapa después de que el DOM esté listo
    setTimeout(() => {
        loadGoogleMaps();
    }, 500);
});

// Event listener para redimensionar ventana
window.addEventListener('resize', debounce(resizeMap, 250));

// Función de debounce para optimizar el redimensionamiento
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Limpiar al salir de la página
window.addEventListener('beforeunload', function() {
    cleanupMap();
});
</script>

<style>
.map-container {
    position: relative;
    overflow: hidden;
}

#map {
    border-radius: 0 0 12px 12px;
}

.map-loader {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 450px;
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

.map-error {
    background: #f8f9fa;
    border-radius: 0 0 12px 12px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Estilos personalizados para la ventana de información */
.gm-style .gm-style-iw-c {
    padding: 0 !important;
    border-radius: 8px !important;
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
}

.gm-style .gm-style-iw-d {
    overflow: hidden !important;
}

.gm-style .gm-style-iw-t::after {
    background: white !important;
}

/* Botón de cerrar personalizado */
.gm-style .gm-style-iw-tc {
    filter: invert(0.4);
    right: 8px !important;
    top: 8px !important;
}

.contact-info .icon-container {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--bs-primary);
    color: white;
    border-radius: 50%;
    transition: all 0.3s ease;
}

.hover-translate {
    transition: transform 0.3s ease;
}

.hover-translate:hover {
    transform: translateX(10px);
}

.form-floating > .form-control:focus ~ label,
.form-floating > .form-control:not(:placeholder-shown) ~ label {
    color: var(--bs-primary);
}

.form-control:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.25);
}

/* Responsive para el mapa */
@media (max-width: 768px) {
    #map {
        height: 350px !important;
    }
    
    .map-loader {
        height: 350px !important;
    }
    
    .info-window-content {
        max-width: 250px !important;
    }
}

/* Animación del spinner */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}